<style>
  .ad-container {
    margin-top: 200px;
    margin-left: 7px;
    width: 240px;
    height: 400px;
    border: 2px dashed #ccc;
    background-color: #f9f9f9;
    color: #555;
    display: flex;
    justify-content: center;
    align-items: center;
    font-family: Arial, sans-serif;
    font-size: 16px;
    text-align: center;
    cursor: pointer;
    transition: background-color 0.3s;
  }

  .ad-container2 {
    
    
    width: 634px;
    height: 60px;
    border: 2px dashed #ccc;
    background-color: #f9f9f9;
    color: #555;
    display: flex;
    justify-content: center;
    align-items: center;
    font-family: Arial, sans-serif;
    font-size: 16px;
    text-align: center;
    cursor: pointer;
    transition: background-color 0.3s;
  }

  .ad-container:hover {
    background-color: #eaeaea;
  }

  .ad-container2:hover {
    background-color: #eaeaea;
  }

  .logout-btn {
  background-color: #0362fc;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 10px;
  cursor: pointer;
  
  font-size: 14px;
  margin-right: 15px;
  transition: background-color 0.3s;
  display: flex;
  align-items: center;
  gap: 8px;
}

.logout-btn:hover {
  background-color: #d32f2f;
}

  
</style>
<!DOCTYPE html>
<html lang="it">
<head>
  <script src="/address.js"></script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Financial Dashboard</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="sidebar.css" />
  <link rel="stylesheet" href="general.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<section class="main-structure">
  <div class="sidebar">
    <div class="banner">
      <a href="index.html" data-page="dashboard.html">
        <img src="images/banner_vert.png" alt="Banner" style="width: 100%; height: 80px; object-fit: contain;" />
      </a>
    </div>
    <nav>
      <h4>Menu</h4>
      <ul>
        <li class="active"><a href="#" id="overviewLink" data-page="dashboard.html"><i class="fas fa-home"></i> Overview</a></li>
        <li><a href="#" id="analyticsLink" data-page="analytics.html"><i class="fas fa-chart-line"></i> Analytics</a></li>
        <li><a href="#" id="profileLink" data-page="profile_edit.html"><i class="fas fa-user-edit"></i> Edit Profile</a></li>
      </ul>
    </nav>
    <div class="support">    
      <h4>Support</h4>
      <nav>
        <ul>
          <li><a href="#" id="profileLink" data-page="FAQ.html"><i class="fas fa-question-circle"></i> Help</a></li>
        </ul>
      </nav>
    </div>
    
    <div class="ad-container" >
      Advertisement Here
    </div>
  </div>

  <div class="main-content">
    <header>
      
      <div class="header-right">
        
        <div class="user-profile">
          <span id="userNameDisplay">Utente</span>
        </div>
        <button id="logoutButton" class="logout-btn">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
        <div class="language-changer">
          <select id="languageSelect">
            <option value="en" selected>English</option>
            <option value="it">Italiano</option>
            <option value="fr">Français</option>
            <option value="es">Español</option>
          </select>
        </div>
      </div>
    </header>
    
    <div id="content-area"></div>
  </div>
</section>
<script src="script.js"></script>
<script src="analytics.js"></script>
<script src="budget.js"></script>
<script src="profile.js"></script>
<script>
	window.addEventListener('pageshow', function (event) {
    if (event.persisted) {
      // La pagina è tornata dalla cache (navigazione indietro)
      me();
    }
  });


    //VARIABILI PER INCOMES AND EXPENSES
    let weeklyBudget, monthlyBudget, annualBudget;

    let transactionsW = 0, transactionsM = 0, transactionsY = 0;

    

    async function fetchBudgetSummary() {
      fetchDates();
      
      try {
        const response = await fetch(`http://localhost:8080/budget/summary`, {
          method: 'GET',
          credentials: 'include'  // per inviare cookie di sessione e mantenere la sessione
        });

        if (!response.ok) {
          throw new Error('Errore nella risposta: ' + response.status);
        }

        const data = await response.json();

        // Aggiorno le variabili globali direttamente
        transactionsW = -data.weeklySum;
        transactionsM = -data.monthlySum;
        transactionsY = -data.yearlySum;

        console.log('Weekly:', transactionsW);
        console.log('Monthly:', transactionsM);
        console.log('Yearly:', transactionsY);
        
      


      } catch (error) {
        console.error('Errore nella fetchBudgetSummary:', error);
        // In caso di errore resettiamo a zero
        transactionsW = 0;
        transactionsM = 0;
        transactionsY = 0;
      }
      
    }

    function updateOverallStats(expenses, incomes) {
      const exp = document.getElementById('overall-expenses');
      const inc = document.getElementById('overall-incomes');
      const tot = document.getElementById('overall-total');
      if (!exp || !inc || !tot) return;
      exp.textContent = `€${expenses.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
      inc.textContent = `€${incomes.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
      tot.textContent = `€${(incomes - expenses).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
    }

    

    function addNewTransaction() {
      const category = document.getElementById("new-category").value;
      const date = document.getElementById("new-dateT").value;
      const type = JSON.parse(document.getElementById("new-type").value);
      const amount = parseFloat(document.getElementById("new-amount").value);
      const description = document.getElementById("new-description").value;

      // Validation
      if (category.length > 20) {
        alert("Category too long (max 20 characters).");
        return;
      }
      if (description.length > 100) {
        alert("Description too long (max 100 characters).");
        return;
      }
      if (isNaN(amount) || amount > 99999999.99) {
        alert("Amount is invalid or too large (Greater than 99999999.99).");
        return;
      }

      const transaction = { category, date, type, amount, description };

      fetch("http://localhost:8080/transaction/add", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify(transaction)
      })
        .then(res => {
          if (res.ok) {
            hideDiv('new-transaction');
            updateDashboardContent();
            fetchTransactions();
          } else {
            alert("Errore durante l'aggiunta della transazione.");
          }
        })
        .catch(err => {
          console.error("Errore:", err);
          alert("Errore di rete o server.");
        });
    }

    function showDiv(id) {
      document.getElementById(id).style.display = 'block';
    }

    // Function to hide a div
    function hideDiv(id) {
      document.getElementById(id).style.display = 'none';
    }

    // Function to clear input
    function clearInput(id) {
      document.getElementById(id).value = 0;
    }
    
    document.addEventListener('DOMContentLoaded', () => {
	  me();
      const logoutButton = document.getElementById('logoutButton');
      if (logoutButton) {
        logoutButton.addEventListener('click', logout);
      }
	    
      const contentArea = document.getElementById('content-area');
      const sidebarLinks = document.querySelectorAll('.sidebar a');
      const languageSelect = document.getElementById('languageSelect');


      getBudget().then(budget => {
        if (budget) {
          weeklyBudget = budget.week;
          monthlyBudget = budget.month;
          annualBudget = budget.year;
        }
      });

      let saldo = 0;
	  
      fetchSaldo().then(totals => {
        if (totals) {
        saldo = -totals;
        }
      });
	  
      
		
		


      /*VARIABILI DA LEGGERE DAL DB QUANDO PAGINA ACCEDE
      MEMORIZZA VALORE DAL QUERY QUI*/
    
    
    
    

    
  

    
    

    // Function to load pages dynamically
    function loadPage(page, callback) {
	  me();
      contentArea.classList.add('hidden');

      setTimeout(() => {
        fetch(page)
          .then((res) => (res.ok ? res.text() : Promise.reject('Failed to load page')))
          .then((html) => {
            contentArea.innerHTML = html;
            contentArea.classList.remove('hidden');

            if (typeof callback === 'function') {
              callback();
            }
          })
          .catch((err) => {
            contentArea.innerHTML = '<p>Error loading content.</p>';
            contentArea.classList.remove('hidden');
            console.error(err);
          });
      }, 200);
    }

    // Function to animate numbers
    function animateContent(element, targetValue) {
      const duration = 1000; // Animation duration in milliseconds
      const increment = targetValue / (duration / 16); // Increment per frame (~60fps)
      let current = 0;

      const prefix = '€';
      const suffix = '';

      function updateContent() {
        current += increment;
        if (current >= targetValue) {
          element.textContent = `${prefix}${targetValue.toLocaleString()}${suffix}`;
        } else {
          element.textContent = `${prefix}${Math.floor(current).toLocaleString()}${suffix}`;
          requestAnimationFrame(updateContent);
        }
      }

      updateContent();
    }

    // Function to update the dashboard content
    async function updateDashboardContent() {
      await fetchBudgetSummary();
      fetchTransactions();
      let weeklyRemaining = weeklyBudget - transactionsW;
      let monthlyRemaining = monthlyBudget - transactionsM;
      let annualRemaining = annualBudget - transactionsY;

      // Calculate averages
      const avgWeekly = transactionsW / 7;
      const avgMonthly = transactionsM / 30;
      const avgAnnual = transactionsY / 365;

      // Animate budget numbers
      const budgetElements = {
        weekly: document.querySelector('.dashboard-number .animated-number:nth-child(1)'),
        monthly: document.querySelector('#monthlyBudgetBox .animated-number:nth-child(1)'),
        annual: document.querySelector('#annualBudgetBox .animated-number:nth-child(1)'),
      };
      const remainingElements = {
        weekly: document.querySelector('.dashboard-number .animated-number:nth-child(2)'),
        monthly: document.querySelector('#monthlyBudgetBox .animated-number:nth-child(2)'),
        annual: document.querySelector('#annualBudgetBox .animated-number:nth-child(2)'),
      };

      if (budgetElements.weekly && remainingElements.weekly) {
        animateContent(budgetElements.weekly, weeklyBudget);
        animateContent(remainingElements.weekly, weeklyRemaining);
      }
      if (budgetElements.monthly && remainingElements.monthly) {
        animateContent(budgetElements.monthly, monthlyBudget);
        animateContent(remainingElements.monthly, monthlyRemaining);
      }
      if (budgetElements.annual && remainingElements.annual) {
        animateContent(budgetElements.annual, annualBudget);
        animateContent(remainingElements.annual, annualRemaining);
      }

      // Animate average daily expenses
      const avgWeeklyElem = document.querySelector('span[data-period="week"]');
      const avgMonthlyElem = document.querySelector('span[data-period="month"]');
      const avgAnnualElem = document.querySelector('span[data-period="year"]');

      if (avgWeeklyElem) animateContent(avgWeeklyElem, avgWeekly);
      if (avgMonthlyElem) animateContent(avgMonthlyElem, avgMonthly);
      if (avgAnnualElem) animateContent(avgAnnualElem, avgAnnual);

      if (avgWeeklyElem) {
        avgWeeklyElem.setAttribute('data-target', avgWeekly.toFixed(2));
        avgWeeklyElem.textContent = `€${avgWeekly.toFixed(2)}`;
      }
      if (avgMonthlyElem) {
        avgMonthlyElem.setAttribute('data-target', avgMonthly.toFixed(2));
        avgMonthlyElem.textContent = `€${avgMonthly.toFixed(2)}`;
      }
      if (avgAnnualElem) {
        avgAnnualElem.setAttribute('data-target', avgAnnual.toFixed(2));
        avgAnnualElem.textContent = `€${avgAnnual.toFixed(2)}`;
      }
    }

    

    // Function to handle budget edit form submission
    function handleBudgetEditForm(type) {
      const budgetForm = document.getElementById(`${type}-budget-edit-input-form`);
      const budgetInput = document.getElementById(`${type}BudgetInput`);

      if (budgetForm) {
        budgetForm.addEventListener('submit', (e) => {
          e.preventDefault(); // Prevent form submission

          /*VARIABILE newBudget DAL FORM DA SETTARE: QUANDO QUALSIASI FORM VIENE ACCETATO
          MEMORIZZA VALORE DAL FORM QUI*/
          const newBudget = parseFloat(budgetInput.value); // Get the input value

          if (isNaN(newBudget) || newBudget < 0 || newBudget > 99999999.99) {
            alert('Budget value is invalid or too large (max 99,999,999.99)');
            return;
          }
        
          if (!isNaN(newBudget) && newBudget >= 0) {
            if (type === 'weekly') {
              weeklyBudget = newBudget;
              weeklyRemaining = weeklyBudget - transactionsW;
            } else if (type === 'monthly') {
              monthlyBudget = newBudget;
              monthlyRemaining = monthlyBudget - transactionsM;
            } else if (type === 'annual') {
              annualBudget = newBudget;
              annualRemaining = annualBudget - transactionsY;
            }

            updateBudget({
              week: weeklyBudget,
              month: monthlyBudget,
              year: annualBudget
            });
			
            updateDashboardContent(); // Re-trigger the animation
            hideDiv(`${type}BudgetBoxEdit`); // Hide the edit form
            showDiv(`${type}BudgetBox`); // Show the main budget box
          } else {
            console.error('Invalid budget input');
          }
        });
      }
    }

    // Initialize sidebar navigation
    sidebarLinks.forEach((link) => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        sidebarLinks.forEach((l) => l.parentElement.classList.remove('active'));
        link.parentElement.classList.add('active');

        const page = link.dataset.page;
        if (page) {
          loadPage(page, () => {
            if (page === 'dashboard.html') {
              me();
              fetchTransactions(); // <-- This updates stats and table
              updateDashboardContent();
              handleBudgetEditForm('weekly');
              handleBudgetEditForm('monthly');
              handleBudgetEditForm('annual');
            }
            if (page === 'analytics.html') {
              inizializzaGrafici()
            }
			if(page === 'profile_edit.html') {
			loadProfile();
           }
          });
        }
      });
    });

    // Handle language selection
    languageSelect.addEventListener('change', () => fetchTranslations(languageSelect.value));

    // Load the default page (dashboard) on page load
    loadPage('dashboard.html', () => {
      updateDashboardContent();
      handleBudgetEditForm('weekly');
      handleBudgetEditForm('monthly');
      handleBudgetEditForm('annual');
      
    });

  });
  
  
</script>





</body>
</html>
